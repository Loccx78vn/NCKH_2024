---
title: "MILP_model_reverse_logistics"
author: "Lá»™c"
date: "2024-03-06"
output: word
---

```{r}
#Call packages
pacman::p_load(rio,
               here,
               janitor,
               tidyverse,
               dplyr,
               magrittr,
               ggplot2,
               purrr,
               lubridate,
               mice,
               plotly)
```

# Input:

This is the case study of building the supply chain model for e-waste. The main problem is how to transship the e-waste to the brand companies with the lowest cost.

The summary of e-waste supply chain is below:

![E-waste supply chain model](/Users/locca/Downloads/Line_chart.png)

```{r}
set.seed(1234)
## Simulate the numbers of TKN,TKL,NM,CA,DN:  
I = 10  ### Meaning there are 20 TKN
J = 5  ### Meaning there are 5 TKN
K = 3  ### Meaning there are 3 TKL
P = 2  ### Meaning there are 2 NM
B = 1  ### Meaning there are 1 DN

## Simulate the demand:
S = as.integer(runif(I,5000,10000))
D = as.integer(runif(B,1000,4000))

## Simulate the operation cost:
fi = as.integer(runif(I,5,20))
fj = as.integer(runif(J,10,20))
fk = as.integer(runif(K,20,50))
fp = as.integer(runif(P,100,500))
pen = as.integer(runif(I,50,100))

## Simulate the transportation cost:
c_TKN = matrix(as.integer(runif(I*J,10,100)),
               nrow = I,
               ncol = J,
               byrow = TRUE)    
c_TKL = matrix(as.integer(runif(J*K,10,200)),
               nrow = J,
               ncol = K,
               byrow = TRUE) 
c_NM = matrix(as.integer(runif(K*P,100,200)),
               nrow = K,
               ncol = P,
               byrow = TRUE) 
c_CA = matrix(as.integer(runif(J*P,200,300)),
               nrow = J,
               ncol = P,
               byrow = TRUE)
c_DN = matrix(as.integer(runif(P*B,1000,2000)),
              nrow = P,
              ncol = B,
              byrow = TRUE)

## Simulate the capacity of TKN,TKL,NM,CA:
wh = as.integer(runif(I,1000,1500)) ##warehouses
dc = as.integer(runif(J,1000,1500)) ##Distributions
mn = as.integer(runif(K,2000,5000)) ##Manufacters
pt = as.integer(runif(P,3000,5000)) ##Ports
br = as.integer(runif(B,10^4,2*10^4)) ##Brands

```

# Model:

```{r}
library(ompr)
library(ompr.roi)
library(ROI.plugin.glpk)

model <- MIPModel() %>%
  
  # Add variables:
  
    ## Indicates the flow movement of e-waste orders:
    add_variable(X_TKN[i,j],
                 i = 1:I,
                 j = 1:J) %>% 
    add_variable(X_TKL[j,k],
                 j = 1:J,
                 k = 1:K) %>% 
    add_variable(X_NM[k,p], 
                 k = 1:K,
                 p = 1:P) %>%
    add_variable(X_CA[j,p],
                 j = 1:J,
                 p = 1:P) %>%
    add_variable(X_DN[p,b], 
                 p = 1:P,
                 b = 1:B) %>% 
  
    ## Indicates the penalty cost:
    add_variable(UN[i], 
                 i = 1:I) %>% 
  # Objective function for minimize the total cost of reverse logistics:
  set_objective(
             
    ## Indicates the penalty cost:
    sum_expr(pen[i]*UN[i],i = 1:I) +
             
    ## Indicates the total cost of transporting the e-watse from TKN to TKL:
    sum_expr(X_TKN[i,j]*c_TKN[i,j], 
             i = 1:I,
             j = 1:J) +
      
    ## Indicates the total cost of transporting the e-watse from TKL to NM (Manufacturer) firstly and then to CA (Port)
    sum_expr(X_TKL[j,k]*c_TKL[j,k],
             j = 1:J,
             k = 1:K) +
    sum_expr(X_NM[k,p]*c_NM[k,p], 
             k = 1:K,
             p = 1:P)+
    
    ## Indicates the total cost of transporting the e-watse from TKL to CA (Port) and do not need to go to NM:
    sum_expr(X_CA[j,p]*c_CA[j,p], 
             j = 1:J,
             p = 1:P) +

    ## Indicates the total cost of transporting the e-watse from CA (Port) to HA (Brand companies):
    sum_expr(X_DN[p,b]*c_DN[p,b], 
             p = 1:P,
             b = 1:B),"min") %>%
  
  # Add constraints of model:
    ## For undemand are not served:
    add_constraint(UN[i] == S[i] - wh[i] - sum_expr(X_TKN[i,j],j = 1:J),
                 i = 1:I) %>% 
    add_constraint(UN[i] >= wh[i],i = 1:I) %>% 
    ## For Xij = Xjk + Xjp
    add_constraint(sum_expr(X_TKN[i,j],i = 1:I) == sum_expr(X_TKL[j,k],k = 1:K) + sum_expr(X_CA[j,p],p = 1:P),j= 1:J) %>%
  
  ## For Xjk = Xkp
    add_constraint(sum_expr(X_TKL[j,k],j = 1:J) == sum_expr(X_NM[k,p],p = 1:P), k = 1:K) %>%
  
    ## For Xkp + Xjp = Xpb:
    add_constraint(sum_expr(X_DN[p,b],b = 1:B) == sum_expr(X_NM[k,p],k = 1:K) + sum_expr(X_CA[j,p],j = 1:J),p = 1:P) %>%
  
    ## For the capacity of TKN, TKL, NM, CA:
    ### With TKN:
    add_constraint(sum_expr(X_TKN[i,j],
                            j = 1:J) <= wh[i],
                  i = 1:I) %>% 
    add_constraint(sum_expr(X_TKN[i,j],
                            i = 1:I) >= dc[j],
                  j = 1:J) %>% 
    ### With TKL:
    add_constraint(sum_expr(X_TKL[j,k],
                            j = 1:J) >= mn[k],
                   k = 1:K) %>% 
    add_constraint(sum_expr(X_TKL[j,k],k = 1:K) <= dc[j],
                   j = 1:J)  %>% 
  
    ### With NM:
    add_constraint(sum_expr(X_NM[k,p],
                            k = 1:K) >= pt[p],
                   p = 1:P) %>% 
    add_constraint(sum_expr(X_NM[k,p],p = 1:P) <= mn[k],
                   k = 1:K) %>%
  
    ### With CA:
    add_constraint(sum_expr(X_CA[j,p],
                            j = 1:J) >= pt[p],
                   p = 1:P) %>% 
    add_constraint(sum_expr(X_CA[j,p],p = 1:P) <= dc[j],
                   j = 1:J) %>% 
  
    ### With DN:  
    add_constraint(sum_expr(X_DN[p,b],
                            b = 1:B) <= pt[p],
                   p = 1:P) %>% 
    add_constraint(sum_expr(X_DN[p,b],p = 1:P) >= D[b],b = 1:B) %>%
  
    ### All are > 0:
    add_constraint(X_TKN[i,j] >= 0, i = 1:I,j = 1:J) %>% 
    add_constraint(X_TKL[j,k] >= 0, k = 1:K,j = 1:J) %>%
    add_constraint(X_NM[k,p] >= 0, k = 1:K,p = 1:P) %>%
    add_constraint(X_CA[j,p] >= 0, j = 1:J,p = 1:P) %>%
    add_constraint(X_DN[p,b] >= 0, p = 1:P,b = 1:B) %>%
  
  #Solve the model:
  solve_model(with_ROI(solver = "glpk", verbose = TRUE))
```

```{r}
TKN <- get_solution(model,X_TKN[i,j]) %>% filter(value > 0)
TKL <- get_solution(model,X_TKL[j,k]) %>% filter(value > 0)
NM <- get_solution(model,X_NM[k,p]) %>% filter(value > 0)
CA <- get_solution(model,X_CA[j,p]) %>% filter(value > 0)
DN <- get_solution(model,X_DN[p,b]) %>% filter(value > 0)
nodes<-data.frame(name = c(unique(str_c(TKN$variable,TKN$i)),
                           unique(str_c(TKL$variable,TKL$j)),
                           unique(str_c(NM$variable,NM$k)),                                    unique(c(str_c(CA$variable,NM$p),                                            str_c(CA$variable,CA$p))),
                           unique(str_c(DN$variable,DN$b)))
)


links<-data.frame(
  source = c(match(str_c("X_TKN",TKN$i),nodes$name)-1,
             match(str_c("X_TKL",TKL$j),nodes$name)-1,
             match(str_c("X_NM",NM$k),nodes$name)-1,
             match(str_c("X_TKL",CA$j),nodes$name)-1,
             match(str_c("X_CA",DN$p),nodes$name)-1),
  
  target = c(match(str_c("X_TKL",TKN$j),nodes$name)-1,
             match(str_c("X_NM",TKL$k),nodes$name)-1,
             match(str_c("X_CA",NM$p),nodes$name)-1,
             match(str_c("X_CA",CA$p),nodes$name)-1,
             match(str_c("X_DN",DN$b),nodes$name)-1),
             
  value = c(TKN$value,TKL$value,NM$value,CA$value,DN$value)
)


library(networkD3)
sankeyNetwork(Links = links, 
              Nodes = nodes, 
              Source = "source",
             Target = "target", 
             Value = "value", 
             NodeID = "name",
             fontSize= 12, 
             nodeWidth = 30)


```
  